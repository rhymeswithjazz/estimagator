name: Deploy to Environment

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip smoke tests (use with caution)'
        required: false
        type: boolean
        default: false

env:
  STAGING_URL: https://staging.estimagator.rhymeswithjazz.com
  PRODUCTION_URL: https://estimagator.rhymeswithjazz.com

jobs:
  determine-environment:
    name: Determine Deployment Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      url: ${{ steps.set-env.outputs.url }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            ENV="staging"
          else
            echo "âŒ Unknown branch: ${{ github.ref }}"
            exit 1
          fi

          echo "environment=${ENV}" >> $GITHUB_OUTPUT

          if [ "${ENV}" == "production" ]; then
            echo "url=${{ env.PRODUCTION_URL }}" >> $GITHUB_OUTPUT
          else
            echo "url=${{ env.STAGING_URL }}" >> $GITHUB_OUTPUT
          fi

          echo "ðŸŽ¯ Deploying to: ${ENV}"

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: determine-environment
    environment:
      name: ${{ needs.determine-environment.outputs.environment }}
      url: ${{ needs.determine-environment.outputs.url }}
    steps:
      - uses: actions/checkout@v6

      - name: Trigger Portainer Webhook
        id: deploy
        run: |
          ENV="${{ needs.determine-environment.outputs.environment }}"

          if [ "${ENV}" == "production" ]; then
            WEBHOOK_URL="${{ secrets.PORTAINER_WEBHOOK_PROD }}"
          else
            WEBHOOK_URL="${{ secrets.PORTAINER_WEBHOOK_STAGING }}"
          fi

          if [ -z "${WEBHOOK_URL}" ]; then
            echo "âŒ Portainer webhook not configured for ${ENV}"
            echo "Please set PORTAINER_WEBHOOK_PROD or PORTAINER_WEBHOOK_STAGING secret"
            exit 1
          fi

          echo "ðŸš€ Triggering deployment to ${ENV}..."

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${WEBHOOK_URL}")

          if [ "${RESPONSE}" -eq 200 ] || [ "${RESPONSE}" -eq 204 ]; then
            echo "âœ… Deployment triggered successfully (HTTP ${RESPONSE})"
            echo "deployment_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          else
            echo "âŒ Deployment failed (HTTP ${RESPONSE})"
            exit 1
          fi

      - name: Wait for deployment to settle
        run: |
          echo "â³ Waiting 30 seconds for containers to start..."
          sleep 30

      - name: Health Check
        id: health
        run: |
          URL="${{ needs.determine-environment.outputs.url }}"
          MAX_RETRIES=10
          RETRY_DELAY=10

          echo "ðŸ¥ Checking health at ${URL}/health"

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${URL}/health" || echo "000")

            if [ "${HTTP_CODE}" -eq 200 ]; then
              echo "âœ… Health check passed (HTTP ${HTTP_CODE})"
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âš ï¸  Health check failed (HTTP ${HTTP_CODE})"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in ${RETRY_DELAY} seconds..."
                sleep $RETRY_DELAY
              fi
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Run Smoke Tests
        if: steps.health.outputs.healthy == 'true' && (inputs.skip_tests != true || github.event_name != 'workflow_dispatch')
        run: |
          chmod +x scripts/smoke-test.sh
          ./scripts/smoke-test.sh "${{ needs.determine-environment.outputs.url }}"

      - name: Deployment Summary
        if: always()
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ needs.determine-environment.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** ${{ steps.deploy.outputs.deployment_time }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.health.outputs.healthy }}" == "true" ]; then
            echo "âœ… **Health Check:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Health Check:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

  notify:
    name: Notify Deployment Status
    needs: [determine-environment, deploy]
    if: always()
    uses: ./.github/workflows/notify.yml
    with:
      status: ${{ needs.deploy.result }}
      workflow_name: 'Deployment to ${{ needs.determine-environment.outputs.environment }}'
      run_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      branch: ${{ github.ref_name }}
      commit_message: ${{ github.event.head_commit.message }}
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
