name: Notify

on:
  workflow_call:
    inputs:
      status:
        description: 'Workflow status (success, failure, cancelled)'
        required: true
        type: string
      workflow_name:
        description: 'Name of the workflow'
        required: true
        type: string
      run_url:
        description: 'URL to the workflow run'
        required: true
        type: string
      branch:
        description: 'Branch name'
        required: true
        type: string
      commit_message:
        description: 'Commit message'
        required: true
        type: string
    secrets:
      SLACK_WEBHOOK_URL:
        description: 'Slack webhook URL for notifications'
        required: false

jobs:
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    steps:
      - name: Determine status emoji and color
        id: status
        run: |
          case "${{ inputs.status }}" in
            success)
              echo "emoji=âœ…" >> $GITHUB_OUTPUT
              echo "color=#36a64f" >> $GITHUB_OUTPUT
              echo "text=Success" >> $GITHUB_OUTPUT
              ;;
            failure)
              echo "emoji=âŒ" >> $GITHUB_OUTPUT
              echo "color=#ff0000" >> $GITHUB_OUTPUT
              echo "text=Failed" >> $GITHUB_OUTPUT
              ;;
            cancelled)
              echo "emoji=â¹ï¸" >> $GITHUB_OUTPUT
              echo "color=#ffa500" >> $GITHUB_OUTPUT
              echo "text=Cancelled" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "emoji=â„¹ï¸" >> $GITHUB_OUTPUT
              echo "color=#808080" >> $GITHUB_OUTPUT
              echo "text=Unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send Slack notification
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d @- <<SLACK_EOF
          {
            "attachments": [
              {
                "color": "${{ steps.status.outputs.color }}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "${{ steps.status.outputs.emoji }} *${{ inputs.workflow_name }}*: ${{ steps.status.outputs.text }}"
                    }
                  },
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "mrkdwn",
                        "text": "*Branch:*\n${{ inputs.branch }}"
                      },
                      {
                        "type": "mrkdwn",
                        "text": "*Status:*\n${{ steps.status.outputs.text }}"
                      }
                    ]
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n${{ inputs.commit_message }}"
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "View Workflow Run"
                        },
                        "url": "${{ inputs.run_url }}"
                      }
                    ]
                  }
                ]
              }
            ]
          }
SLACK_EOF

      - name: Log notification sent
        if: secrets.SLACK_WEBHOOK_URL != ''
        run: |
          echo "ðŸ“¬ Slack notification sent for ${{ inputs.workflow_name }}"
          echo "Status: ${{ inputs.status }}"
          echo "Branch: ${{ inputs.branch }}"

      - name: Skip notification (webhook not configured)
        if: secrets.SLACK_WEBHOOK_URL == ''
        run: |
          echo "âš ï¸ Slack webhook not configured, skipping notification"
          echo "To enable notifications, set the SLACK_WEBHOOK_URL secret"
